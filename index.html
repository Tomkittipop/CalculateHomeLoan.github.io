<!DOCTYPE html>
<html lang="th">

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำนวณการชำระหนี้บ้าน</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1a365d;
        }

        .input-section {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2563eb;
        }

        .summary-section {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-label {
            font-weight: normal;
        }

        .summary-value {
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tr:hover {
            background-color: #f3f4f6;
        }

        .text-right {
            text-align: right;
        }

        .hidden {
            display: none;
        }

        .export-btn {
            background-color: #10b981;
            margin-top: 20px;
        }

        .export-btn:hover {
            background-color: #059669;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            th,
            td {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>คำนวณการชำระหนี้บ้าน</h1>

        <div class="input-section">
            <div class="input-grid">
                <div class="input-group">
                    <label for="loanAmount">ยอดหนี้เริ่มต้น (บาท)</label>
                    <input type="number" id="loanAmount" value="" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label for="interestRate">อัตราดอกเบี้ย (% ต่อปี)</label>
                    <input type="number" id="interestRate" value="" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label for="monthlyPayment">ยอดชำระต่องวด (บาท)</label>
                    <input type="number" id="monthlyPayment" value="" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label for="startDate">วันที่เริ่มสัญญา</label>
                    <input type="date" id="startDate">
                </div>

                <div class="input-group">
                    <label for="paymentDay">วันที่ชำระในแต่ละเดือน (1-31)</label>
                    <input type="number" id="paymentDay" value="18" min="1" max="31" step="1">
                </div>
            </div>

            <button id="calculateBtn">คำนวณ</button>
        </div>

        <div id="summarySection" class="summary-section hidden">
            <h2>สรุปข้อมูล</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">เงินกู้ทั้งหมด:</span>
                    <span id="totalLoan" class="summary-value">0 บาท</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">จำนวนงวดทั้งหมด:</span>
                    <span id="totalPayments" class="summary-value">0 งวด</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">จ่ายทั้งหมด:</span>
                    <span id="totalAmount" class="summary-value">0 บาท</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">ดอกเบี้ยทั้งหมด:</span>
                    <span id="totalInterest" class="summary-value">0 บาท</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">วันที่ชำระเสร็จสิ้น:</span>
                    <span id="payoffDate" class="summary-value">-</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">ระยะเวลาผ่อนชำระ:</span>
                    <span id="loanTerm" class="summary-value">0 ปี 0 เดือน</span>
                </div>
            </div>
        </div>

        <div id="scheduleSection" class="hidden">
            <h2>ตารางการชำระหนี้</h2>
            <div style="overflow-x: auto;">
                <table id="paymentSchedule">
                    <thead>
                        <tr>
                            <th>งวดที่</th>
                            <th>วันที่ชำระ</th>
                            <th>จำนวนวัน</th>
                            <th>ยอดชำระ (บาท)</th>
                            <th>ดอกเบี้ย (บาท)</th>
                            <th>เงินต้น (บาท)</th>
                            <th>ยอดคงเหลือ (บาท)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button id="exportCsvBtn" class="export-btn">Export to CSV</button>
            <button id="exportPdfBtn" class="export-btn" style="background-color:rgb(255, 71, 71);">Export to
                PDF</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Set default date
            const today = new Date();
            document.getElementById('startDate').value = today.toISOString().split('T')[0];

            const calculateBtn = document.getElementById('calculateBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');

            calculateBtn.addEventListener('click', calculateMortgage);
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportPdfBtn.addEventListener('click', exportToPdf);

            function calculateMortgage() {
                // รับค่าจาก input
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const annualInterestRate = parseFloat(document.getElementById('interestRate').value) / 100;
                const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value);
                const startDate = new Date(document.getElementById('startDate').value);
                const paymentDay = parseInt(document.getElementById('paymentDay').value);

                // ตรวจสอบค่า input ว่าถูกต้องหรือไม่
                if (isNaN(loanAmount) || isNaN(annualInterestRate) || isNaN(monthlyPayment) || !startDate || isNaN(paymentDay)) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
                    return;
                }

                // ตรวจสอบว่าวันที่ชำระอยู่ในช่วง 1-31
                if (paymentDay < 1 || paymentDay > 31) {
                    alert('วันที่ชำระต้องอยู่ระหว่าง 1-31');
                    return;
                }

                // คำนวณอัตราดอกเบี้ยต่อวัน
                const dailyInterestRate = annualInterestRate / 365;

                // เริ่มต้นคำนวณตารางการชำระหนี้
                let balance = loanAmount;
                let currentDate = new Date(startDate);
                let paymentNumber = 1;
                let schedule = [];

                // คำนวณจนกว่ายอดหนี้จะหมด
                while (balance > 0) {
                    // คำนวณวันชำระงวดถัดไป
                    let nextPaymentDate = new Date(currentDate);
                    nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
                    
                    // กำหนดวันที่ของเดือนตามที่ผู้ใช้กำหนด
                    nextPaymentDate.setDate(1); // เริ่มที่วันที่ 1 ของเดือน
                    
                    // ตรวจสอบจำนวนวันสูงสุดในเดือนนั้น
                    const lastDayOfMonth = new Date(nextPaymentDate.getFullYear(), nextPaymentDate.getMonth() + 1, 0).getDate();
                    
                    // กำหนดวันที่ชำระโดยไม่เกินจำนวนวันในเดือนนั้น
                    const actualPaymentDay = Math.min(paymentDay, lastDayOfMonth);
                    nextPaymentDate.setDate(actualPaymentDay);

                    // คำนวณจำนวนวันระหว่างงวด
                    const daysInPeriod = Math.round((nextPaymentDate - currentDate) / (1000 * 60 * 60 * 24));

                    // คำนวณดอกเบี้ยสำหรับงวดนี้
                    const interestForPeriod = balance * dailyInterestRate * daysInPeriod;

                    // คำนวณเงินต้นที่ชำระในงวดนี้
                    let principalPayment = monthlyPayment - interestForPeriod;

                    // ตรวจสอบงวดสุดท้าย
                    let actualPayment = monthlyPayment;
                    if (balance + interestForPeriod < monthlyPayment) {
                        actualPayment = balance + interestForPeriod;
                        principalPayment = balance;
                    }

                    // ปรับยอดคงเหลือ
                    balance = Math.max(0, balance - principalPayment);

                    // เพิ่มข้อมูลลงในตาราง
                    schedule.push({
                        paymentNumber: paymentNumber,
                        date: new Date(nextPaymentDate),
                        daysInPeriod: daysInPeriod,
                        payment: actualPayment,
                        interest: interestForPeriod,
                        principal: principalPayment,
                        remainingBalance: balance
                    });

                    // เตรียมสำหรับงวดถัดไป
                    currentDate = new Date(nextPaymentDate);
                    paymentNumber++;

                    // หากชำระหมดแล้ว ให้ออกจากลูป
                    if (balance <= 0) {
                        break;
                    }
                }

                // คำนวณสรุป
                let totalInterest = 0;
                let totalPayment = 0;

                schedule.forEach(row => {
                    totalInterest += row.interest;
                    totalPayment += row.payment;
                });

                // แสดงผลสรุป
                document.getElementById('totalLoan').textContent = formatCurrency(loanAmount) + ' บาท';
                document.getElementById('totalPayments').textContent = schedule.length + ' งวด';
                document.getElementById('totalAmount').textContent = formatCurrency(totalPayment) + ' บาท';
                document.getElementById('totalInterest').textContent = formatCurrency(totalInterest) + ' บาท';
                document.getElementById('payoffDate').textContent = formatDate(schedule[schedule.length - 1].date);
                document.getElementById('loanTerm').textContent =
                    Math.floor(schedule.length / 12) + ' ปี ' +
                    (schedule.length % 12) + ' เดือน';

                // แสดง section สรุปข้อมูล
                document.getElementById('summarySection').classList.remove('hidden');

                // สร้างตารางการชำระหนี้
                const tableBody = document.querySelector('#paymentSchedule tbody');
                tableBody.innerHTML = '';

                schedule.forEach(row => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${row.paymentNumber}</td>
                        <td>${formatDate(row.date)}</td>
                        <td>${row.daysInPeriod}</td>
                        <td class="text-right">${formatCurrency(row.payment)}</td>
                        <td class="text-right">${formatCurrency(row.interest)}</td>
                        <td class="text-right">${formatCurrency(row.principal)}</td>
                        <td class="text-right">${formatCurrency(row.remainingBalance)}</td>
                    `;
                    tableBody.appendChild(newRow);
                });

                // แสดง section ตารางการชำระหนี้
                document.getElementById('scheduleSection').classList.remove('hidden');

                // Store schedule for CSV export
                window.paymentSchedule = schedule;
            }

            function exportToCsv() {
                if (!window.paymentSchedule || window.paymentSchedule.length === 0) {
                    alert('กรุณาคำนวณตารางการชำระหนี้ก่อน');
                    return;
                }

                // CSV headers
                const headers = [
                    'งวดที่',
                    'วันที่ชำระ',
                    'จำนวนวัน',
                    'ยอดชำระ (บาท)',
                    'ดอกเบี้ย (บาท)',
                    'เงินต้น (บาท)',
                    'ยอดคงเหลือ (บาท)'
                ];

                // CSV rows
                const rows = window.paymentSchedule.map(row => [
                    row.paymentNumber,
                    formatDate(row.date),
                    row.daysInPeriod,
                    row.payment.toFixed(2),
                    row.interest.toFixed(2),
                    row.principal.toFixed(2),
                    row.remainingBalance.toFixed(2)
                ]);

                // Create CSV content with UTF-8 BOM
                const csvContent = [
                    '\uFEFF' + headers.join(','), // Add BOM for UTF-8
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'payment_schedule.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // ฟังก์ชันฟอร์แมตวันที่เป็น dd/mm/yyyy
            function formatDate(date) {
                return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            }

            // ฟังก์ชันฟอร์แมตตัวเลขเป็นสกุลเงินบาท
            function formatCurrency(amount) {
                return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            }

            // เพิ่มในส่วน scriptPDF
            function exportToPdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // กำหนดหัวตารางเป็นภาษาอังกฤษโดยตรง
                const headers = ['Payment No.', 'Date', 'Days', 'Payment', 'Interest', 'Principal', 'Balance'];

                const table = document.getElementById('paymentSchedule');
                const body = [];
                const bodyElements = table.querySelectorAll('tbody tr');
                bodyElements.forEach(tr => {
                    const rowData = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
                    body.push(rowData);
                });

                doc.autoTable({
                    head: [headers],
                    body: body,
                    styles: {
                        fontSize: 10,
                        cellPadding: 1.5,
                        overflow: 'linebreak',
                        halign: 'center',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [0, 0, 0],
                        color: [0, 0, 0],
                        fontStyle: 'bold',
                        halign: 'center'
                    }
                });

                doc.save('payment_schedule.pdf');
            }
        });
    </script>
</body>

</html>